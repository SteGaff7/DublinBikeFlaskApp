<!DOCTYPE html>
<html lang="en">
<head>
  <title>Home Page</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/template.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.4.1/js/bootstrap-datepicker.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.4.1/css/bootstrap-datepicker3.css"/>


</head>

<style>
    table, th, td {
      border: 1px solid black;
    }
      .filter {padding-top: 2%; font-size: 10pt; padding-bottom: 0%; margin-bottom: 10px; margin-right: 0%; float: left;}
    #address {border: solid; border-color: #234a55; font-size: 11pt; font-style: italic; padding: 1%; width: 600px; margin-left: 10%; }
    #station_name {border: solid; border-color: #234a55; font-size: 11pt; font-style: italic; padding: 0.5%; width: 90%; margin-left: 5%; }
    #date {border: solid; border-color: #234a55; font-size: 11pt; font-style: italic; padding: 0.5%; width: 45%; margin-left: 5%; margin-bottom: 0px; }
    #time {border: solid; border-color: #234a55; font-size: 11pt; font-style: italic; padding: 0.5%; width: 45%;}
    #gobutton { border: solid; border-color: #234a55; font-size: 11pt; font-style: italic; padding: 0.5%; width: 40%;margin-left: 5%; margin-bottom: 0px;}
    #gobutton:hover {color: white; background-color: #234a55; }
    .form-control {border: solid; border-color: #234a55; font-size: 11pt; font-style: italic; padding: 0.5%; width: 20%; margin-left: 3%;}
    label {margin-left: 3%; padding-bottom: 0px; padding-top: 0px;}
    #googlemap {width: 50%; height: 325px; margin-top: 1%; margin-left: 3%;}
    #radiobutton1 {margin-left: 10%; margin-right: 1%;}
    #radiobutton2 {margin-left: 10%; margin-right: 1%;}
    #radiobutton3 {margin-left: 10%; margin-right: 1%;}
    #Analytics {margin-right: 2%; margin-top: 1%; height: 600px; width: 35%; float:right; outline-style: solid; outline-color: black;}
    .text {border-color: #234a55; border: solid; float: right; width: 30%; padding: 2%; line-height: 100%; margin-right: 3%; padding-bottom: 50%;}
    #Analytics2 {margin-right: 2%; margin-top: 1%; height: 600px; width: 35%; float:right; outline-style: solid; outline-color: black;}
    #weather {box-sizing: border-box;}
    <span class="metadata-marker" style="display: none;" data-region_tag="css"></span>
</style>


<body onload="weatherToday()">
   <h1><img src="{{ url_for('static', filename='images/dublinbikeslogo.png') }}" width="20%" height="60px" id="dublinbikeslogo"> <img src="{{ url_for('static', filename='images/dublincitycouncil.png') }}" width="20%" height="60px" id="dublincitycouncil"></h1>
<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>conflicts
        <span class="icon-bar"></span>
      </button>
    </div>
    <div class="collapse navbar-collapse" id="myNavbar">
      <ul class="nav navbar-nav">
        <li class="active"><a href="#">Stations</a></li>
        <li><a href="how_it_works.html">How it Works</a></li>
        <li><a href="subscription.html">Subscriptions</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
    </div>
  </div>
</nav>


<!-- BUTTONS -->



<div id="topDiv" style="height:200px;">
<div class="filter">

  <!--SEARCH BUTTON-->
  <div id="locationField">
    <input id="autocomplete"
           placeholder="Enter your address"
           onFocus="geolocate()"
           type="text"/>
  </div>

  <!--RADIO BUTTONS-->



  <input type="radio" name="station" id="radiobutton1" onclick="showAll()"> Display all stations<br>
  <input type="radio" name="station" id="radiobutton2" onclick="collectBike()">  Collect a bike<br>
  <input type="radio" name ="station" id="radiobutton3" onclick="returnBike()"> Drop off a bike<br>
  <!--<input type="button" value="Clear" onclick="clearMarkers()">-->

</div>


<!--PREDICTIVE DATA-->

<div id="Form" style="width:40%; float:right;">
  <form id= "myForm" onsubmit="predictive()">
    <input type="text" name="station_name" id="station_name" list="stations" placeholder=" Enter station name..."><br><br>

    <input type="date" id="date" data-date-inline-picker="true" max="" min="">

    <input type="time" id="time" step="1800"><br><br>
    <input type="submit"><br>

    <!-- Populate datalist with JS -->
    <datalist id="stations">
    </datalist>

  </form>
  </div>
</div>


<div id="bottomDiv">
<div id="Analytics2" style="height:700px;">
  <div id="title" style="height:15%;"><h1>REAL TIME / DATA</h1></div>
<div id="data" style="height:25%; background-color: blue;">
    <h2>DATA</h2>
      <span id='name2'></span><br>
      <span id='status2'></span><br>
      <span id='banking2'></span><br>
      <span id='bikes2'></span><br>
      <span id='stands2'></span><br>
      <span id='updated2'></span>
  </div>
  <div id="weather" style="height:25%; background-color:lightgreen;"><h2>WEATHER</h2>
    <div id="1w", style="width:25%; height: 90%; background-color:red; display: inline-block;"></div><div id="2w", style="width:25%; height: 90%; background-color:white; display: inline-block; "></div><div id="3w", style="width:25%; height: 90%; background-color:blue; display: inline-block;"></div><div id="4w", style="width:25%; height: 90%; background-color:green; display: inline-block;"></div>
  </div>
  <div id="graph" style="height:30%; background-color:lightgrey;"><h2>GRAPH</h2></div>
</div>



 <!-- GOOGLE MAP INTERFACE -->
<span class="metadata-marker" style="display: none;" data-region_tag="html-body"></span>

<div id="map" style="height:700px; width:55%; margin-left:1%; margin-top:1%; margin-bottom:2%;"  >Map goes here</div>
</div>

 <!-- FOOTER -->
<footer class="container-fluid" style="position:static; clear:both;">
    <p> &copy; 2019 dublinbikes. All Rights Reserved.</p>
</footer>



<!--SCRIPTS-->
<script>

var map;
var markers = [];

function initMap() {
  // AutoComplete object
  new google.maps.event.addDomListener(window, 'load', initAutocomplete);

  // The map, centered at Stephens Green
  map = new google.maps.Map(
      document.getElementById('map'), {zoom: 14, center: {lat:  53.347082, lng: -6.264192}});

  // An info window shared by all markers
  var infowindow = new google.maps.InfoWindow({
      content: "<div id='popUp'>" +
      "<span id='name'></span><br>"+
      "<span id='status'></span><br>"+
      "<span id='bikes'></span><br>"+
      "<span id='stands'></span><br>"+
      "</div>"
    });

    {% for item in Data %}
      statNum = {{item[0]}};
      statName = '{{item[1]}}';

      // Convert station name to Capitialized lower case
      statName = statName.toLowerCase();
      split = statName.split(" ");
      statName = "";
      split.forEach(function(element) {
        upper = element.slice(0,1);
        remainder = element.slice(1);
        upper = upper.toUpperCase();
        statName += upper + remainder + " ";
        });
      statName = statName.trim();

      statStatus = '{{item[2]}}';
      statTotalStands = parseFloat({{item[3]}});
      statAvailBikes = parseFloat({{item[4]}});
      statAvailStands = parseFloat({{item[5]}});
      statTime = {{item[6]}};
      statBank = '{{item[7]}}';
      if (statBank == 0) {
        statBank = "No";
      }
      else {
        statBank = "Yes";
      }
      statLat = '{{item[8]}}';
      statLng = '{{item[9]}}';
      statAddress = '{{item[10]}}';
      statDate = new Date(statTime);
      statHours = statDate.getHours();
      if (statHours < 10) {
        statHours = "0" + statHours;
      }
      statMins = statDate.getMinutes();
      if (statMins < 10) {
        statMins = "0" + statMins;
      }
      statSecs = statDate.getSeconds();


    /* Create datalist of each  */
    document.getElementById("stations").innerHTML += "<option>"+statName+"</option><br>";


    /*Create a marker with the name marker+stationNumber*/
    var marker{{item[0]}} = new google.maps.Marker({position: {lat:  parseFloat(statLat), lng: parseFloat(statLng)}, icon: {url: '/images/bike.png', scaledSize: new google.maps.Size(25, 25)}, map: map, });

    marker{{item[0]}}.metadata = {type: "point", id: statNum, name: statName, bikes: statAvailBikes,
      stands: statAvailStands, banking: statBank, totalStands: statTotalStands, status: statStatus,
      address: statAddress, last_checked: statTime, time: statDate, hour: statHours, min: statMins, sec: statSecs, icon: {} };


    /* Function to assign appropriate icon */
    markerIconBikesAvail(marker{{item[0]}});

    markers.push(marker{{item[0]}});


    /* Multiple info window method
    var infowindow{{item[0]}} = new google.maps.InfoWindow({
    content: "<div id='popUp'>" +
    "<span id='name"+{{item[0]}}+"'></span><br>"+
    "<span id='status"+{{item[0]}}+"'></span><br>"+*/
    /*"<span id='banking"+{{item[0]}}+"'></span><br>"+*/
    /*"<span id='bikes"+{{item[0]}}+"'></span><br>"+
    "<span id='stands"+{{item[0]}}+"'></span><br>"+*/
    /*"<span id='updated"+{{item[0]}}+"'></span>*//*"</div>"
    });*/

    /*Add an onclick function unique to each marker*/
    marker{{item[0]}}.addListener('click', function() {
          map.setZoom(16);
          map.setCenter(marker{{item[0]}}.getPosition());

          $.get("retrieve/"+marker{{item[0]}}.metadata.id, function(jsonData) {
            marker{{item[0]}}.metadata['bikes'] = jsonData[0][0];
            marker{{item[0]}}.metadata['stands'] = jsonData[0][1];
            marker{{item[0]}}.metadata['last_checked'] = jsonData[0][2];


            statDate = new Date(jsonData[0][2]);
            statHours = statDate.getHours();
            if (statHours < 10) {
              statHours = "0" + statHours;
            }
            marker{{item[0]}}.metadata['hour'] = statHours;

            statMins = statDate.getMinutes();
            if (statMins < 10) {
              statMins = "0" + statMins;
            }
            marker{{item[0]}}.metadata['min'] = statMins;

            console.log(marker{{item[0]}}.metadata['bikes'] + "<br>" + marker{{item[0]}}.metadata['stands'] + "<br>" + marker{{item[0]}}.metadata['hour'] + ":" +  marker{{item[0]}}.metadata['min']);

            /* Display data in the box to the side */
            document.getElementById("name2").innerHTML = "Name: " + marker{{item[0]}}.metadata['name'];
            document.getElementById("status2").innerHTML = "Status: " + marker{{item[0]}}.metadata['status'];
            document.getElementById("banking2").innerHTML = "Banking: " + marker{{item[0]}}.metadata['banking'];
            document.getElementById("bikes2").innerHTML ="Bikes: " + marker{{item[0]}}.metadata['bikes'] +"/"+marker{{item[0]}}.metadata['totalStands'];
            document.getElementById("stands2").innerHTML = "Stands: " + marker{{item[0]}}.metadata['stands'] +"/"+marker{{item[0]}}.metadata['totalStands'];
            document.getElementById("updated2").innerHTML = "Updated: " + marker{{item[0]}}.metadata['hour'] + ":" + marker{{item[0]}}.metadata['min'];

            /* Multiple info window methods
            document.getElementById("name"+{{item[0]}}).innerHTML = "Name: " + marker{{item[0]}}.metadata['name'];
            document.getElementById("status"+{{item[0]}}).innerHTML = "Status: " + marker{{item[0]}}.metadata['status'];*/
            /*document.getElementById("banking"+{{item[0]}}).innerHTML = "Banking: " + marker{{item[0]}}.metadata['banking'];*/
            /*document.getElementById("bikes"+{{item[0]}}).innerHTML ="Bikes: " + marker{{item[0]}}.metadata['bikes'] +"/"+marker{{item[0]}}.metadata['totalStands'];
            document.getElementById("stands"+{{item[0]}}).innerHTML = "Stands: " + marker{{item[0]}}.metadata['stands'] +"/"+marker{{item[0]}}.metadata['totalStands'];*/
            /*document.getElementById("updated"+{{item[0]}}).innerHTML = "Updated: " + marker{{item[0]}}.metadata['hour'] + ":" + marker{{item[0]}}.metadata['min'];*/




            /* 1 info window method */
            document.getElementById("name").innerHTML = "Name: " + marker{{item[0]}}.metadata['name'];
            document.getElementById("status").innerHTML = "Status: " + marker{{item[0]}}.metadata['status'];
            document.getElementById("bikes").innerHTML ="Bikes: " + marker{{item[0]}}.metadata['bikes'] +"/"+marker{{item[0]}}.metadata['totalStands'];
            document.getElementById("stands").innerHTML = "Stands: " + marker{{item[0]}}.metadata['stands'] +"/"+marker{{item[0]}}.metadata['totalStands'];
          });
          infowindow.open(map, marker{{item[0]}});
          displayWeatherToday();
        });
  {% endfor %}
}


</script>


<script>

var autocomplete;

function initAutocomplete() {
  /*Create the autocomplete object, restricting the search predictions to
   geographical location types. */
  autocomplete = new google.maps.places.Autocomplete(
      document.getElementById('autocomplete'), {types: ['geocode']});

  /* Avoid paying for data that you don't need by restricting the set of
   place fields that are returned to just the address components.
   Also included the geometry */
  autocomplete.setFields(['address_components', 'geometry']);

  /* When the user selects an address from the drop-down, populate the
   address fields in the form. */
  autocomplete.addListener('place_changed', centerPlace);
}

function centerPlace() {
  /* Get the place details from the autocomplete object. */
  var place = autocomplete.getPlace();
  map.setCenter(place.geometry.location);
  map.setZoom(17);
  }

/* Bias the autocomplete object to the user's geographical location,
 as supplied by the browser's 'navigator.geolocation' object. */
function geolocate() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var geolocation = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };

      var circle = new google.maps.Circle(
          {center: geolocation, radius: position.coords.accuracy});
      autocomplete.setBounds(circle.getBounds());
    });
  }
}
</script>


<!--SCRIPT ASYNC-->

<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBQaoCAjS9IUKIW0iRV72fRFn1DQy_7ndA&libraries=places&callback=initMap">
</script>


<!--JAVASCRIPT FUNCTIONS-->

<script>

/* Declare global array variable to cache todays weather forecast for real time data*/
var weatherArrayToday;

/* Set marker bike icon according to bike availability */
function markerIconBikesAvail(marker) {
  if (marker.metadata['bikes']/marker.metadata['totalStands'] >= 0.6) {
    var icon = {url:'images/bike_available.png', scaledSize: new google.maps.Size(20, 25)};
    marker.setIcon(icon);
  }

  else if (marker.metadata['bikes']/marker.metadata['totalStands'] >= 0.15) {
    var icon = {url:'images/bike_moderate.png', scaledSize: new google.maps.Size(20, 25)};
    marker.setIcon(icon);
  }

  else if (marker.metadata['bikes']/marker.metadata['totalStands'] < 0.15) {
    var icon = {url:'images/bike_full.png', scaledSize: new google.maps.Size(20, 25)};
    marker.setIcon(icon);
  }
}

function markerIconStandsAvail(marker) {
  if (marker.metadata['stands']/marker.metadata['totalStands'] >= 0.6) {
    var icon = {url:'images/park_available.png', scaledSize: new google.maps.Size(20, 25)};
    marker.setIcon(icon);
  }
  else if (marker.metadata['stands']/marker.metadata['totalStands'] >= 0.15) {
    var icon = {url:'images/park_moderate.png', scaledSize: new google.maps.Size(20, 25)};
    marker.setIcon(icon);
  }

  else if (marker.metadata['stands']/marker.metadata['totalStands'] < 0.15) {
    var icon = {url:'images/park_full.png', scaledSize: new google.maps.Size(20, 25)};
    marker.setIcon(icon);
  }
}

function clearMarkers() {
  for (var i = 0; i < markers.length; i++) {
    markers[i].setMap();
  }
}
function showAll() {
  for (var i = 0; i < markers.length; i++) {
    markerIconBikesAvail(markers[i]);
    markers[i].setMap(map);
  }
}
function collectBike() {
  clearMarkers();
  for (var i = 0; i < markers.length; i++) {
    if (markers[i].metadata['bikes'] != 0) {
      markerIconBikesAvail(markers[i]);
      markers[i].setMap(map);
    }
  }
}
function returnBike() {
  clearMarkers();
  for (var i = 0; i < markers.length; i++) {
    if (markers[i].metadata['stands'] != 0) {
      markerIconStandsAvail(markers[i]);
      markers[i].setMap(map);
    }
  }
}
function predictive() {
  /*Prevent page reloading each time function is run*/
  event.preventDefault();
  var station_name = document.getElementById("station_name").value;
  var date = document.getElementById("date").value;
  var time = document.getElementById("time").value;

  console.log(station_name, date, time);

  $.get("weatherForecast/" + date, function(returnedData) {
    /*hard coded for now*/
      document.getElementById("1w").innerHTML= "";
      document.getElementById("2w").innerHTML= "";
      document.getElementById("3w").innerHTML= "";
      document.getElementById("4w").innerHTML= "";

      document.getElementById("1w").innerHTML+= returnedData["09:00:00"]["weather"] + "<br>";
      document.getElementById("1w").innerHTML+= returnedData["09:00:00"]["temp"] + "<br>";
      var iconImage = '<img src='+'"http://openweathermap.org/img/w/' + returnedData["09:00:00"]["icon"] + '.png">';
      document.getElementById("1w").innerHTML+= iconImage;
      document.getElementById("1w").innerHTML+= "<br>09:00";

      document.getElementById("2w").innerHTML+= returnedData["12:00:00"]["weather"] + "<br>";
      document.getElementById("2w").innerHTML+= returnedData["12:00:00"]["temp"] + "<br>";
      var iconImage = '<img src='+'"http://openweathermap.org/img/w/' + returnedData["12:00:00"]["icon"] + '.png">';
      document.getElementById("2w").innerHTML+= iconImage;
      document.getElementById("2w").innerHTML+= "<br>12:00";

      document.getElementById("3w").innerHTML+= returnedData["15:00:00"]["weather"] + "<br>";
      document.getElementById("3w").innerHTML+= returnedData["15:00:00"]["temp"] + "<br>";
      var iconImage = '<img src='+'"http://openweathermap.org/img/w/' + returnedData["15:00:00"]["icon"] + '.png">';
      document.getElementById("3w").innerHTML+= iconImage;
      document.getElementById("3w").innerHTML+=  "<br>15:00";


      document.getElementById("4w").innerHTML+= returnedData["18:00:00"]["weather"] + "<br>";
      document.getElementById("4w").innerHTML+= returnedData["18:00:00"]["temp"] + "<br>";
      var iconImage = '<img src='+'"http://openweathermap.org/img/w/' + returnedData["18:00:00"]["icon"] + '.png">';
      document.getElementById("4w").innerHTML+= iconImage;
      document.getElementById("4w").innerHTML+=  "<br>18:00";
    });
  /*$.get("algo/" + date + time + station_name, function(returnedData) {
    document.getElementById("Test").innerHTML= returnedData;
  });*/
};



function weatherToday() {
  $.get("weatherToday", function(returnedData) {
    weatherArrayToday = returnedData;
    });
};

function displayWeatherToday() {

  document.getElementById("1w").innerHTML= "";
  document.getElementById("2w").innerHTML= "";
  document.getElementById("3w").innerHTML= "";
  document.getElementById("4w").innerHTML= "";

  document.getElementById("1w").innerHTML+= weatherArrayToday[0][1] + "<br>";
  document.getElementById("1w").innerHTML+= weatherArrayToday[0][2] + "<br>";
  var iconImage = '<img src='+'"http://openweathermap.org/img/w/' + weatherArrayToday[0][3] + '.png">';
  document.getElementById("1w").innerHTML+= iconImage + "<br>";
  document.getElementById("1w").innerHTML+= weatherArrayToday[0][0];

  document.getElementById("2w").innerHTML+= weatherArrayToday[1][1] + "<br>";
  document.getElementById("2w").innerHTML+= weatherArrayToday[1][2] + "<br>";
  var iconImage = '<img src='+'"http://openweathermap.org/img/w/' + weatherArrayToday[1][3] + '.png">';
  document.getElementById("2w").innerHTML+= iconImage + "<br>";
  document.getElementById("2w").innerHTML+= weatherArrayToday[1][0];

  document.getElementById("3w").innerHTML+= weatherArrayToday[2][1] + "<br>";
  document.getElementById("3w").innerHTML+= weatherArrayToday[2][2] + "<br>";
  var iconImage = '<img src='+'"http://openweathermap.org/img/w/' + weatherArrayToday[2][3] + '.png">';
  document.getElementById("3w").innerHTML+= iconImage + "<br>";
  document.getElementById("3w").innerHTML+= weatherArrayToday[2][0];

  document.getElementById("4w").innerHTML+= weatherArrayToday[3][1] + "<br>";
  document.getElementById("4w").innerHTML+= weatherArrayToday[3][2] + "<br>";
  var iconImage = '<img src='+'"http://openweathermap.org/img/w/' + weatherArrayToday[3][3] + '.png">';
  document.getElementById("4w").innerHTML+= iconImage + "<br>";
  document.getElementById("4w").innerHTML+= weatherArrayToday[3][0];
}



/* Date objects for Calendar */
var today = new Date();
var dd = today.getDate();
var mm = today.getMonth()+1; //January is 0!
var yyyy = today.getFullYear();

if(dd<10){
       dd='0'+dd;
   }
if(mm<10){
       mm='0'+mm;
   }

today = yyyy+'-'+mm+'-'+dd;



var maxDate = new Date();
maxDate.setDate(maxDate.getDate() + 4);

var maxdd = maxDate.getDate();
var maxmm = maxDate.getMonth()+1; //January is 0!
var maxyyyy = maxDate.getFullYear();

if(maxdd<10) {
  maxdd='0'+maxdd;
}
if(maxmm<10){
       maxmm='0'+maxmm;
}

maxDate = maxyyyy+'-'+maxmm+'-'+maxdd;


document.getElementById("date").setAttribute("min", today);
document.getElementById("date").setAttribute("max", maxDate);

console.log(today, maxDate);

</script>
</body>
</html>
